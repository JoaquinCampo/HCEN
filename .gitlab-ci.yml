stages: [deploy]

deploy-on-main:
  image: quay.io/openshift/origin-cli:4.14
  stage: deploy
  variables:
    BC_NAME: "tse-component"
    K_SERVICE: "tse-component"
  script:
    - oc login "$OCP_SERVER" --token="$OCP_TOKEN" --insecure-skip-tls-verify=true

    # 1) trigger the OpenShift build and wait for it to finish
    - oc start-build "$BC_NAME" -n "$OCP_NAMESPACE" --wait --follow

    # 2) bump the Knative Service to create a new revision that resolves :latest
    - ROLLOUT_TS="${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}"
    - oc patch ksvc "$K_SERVICE" -n "$OCP_NAMESPACE" --type=merge -p "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"rolloutTimestamp\":\"${ROLLOUT_TS}\"}}}}}"

    # 3) wait until the service is Ready again
    - oc wait ksvc/"$K_SERVICE" -n "$OCP_NAMESPACE" --for=condition=Ready --timeout=300s

    # show the current URL and latest revision
    - oc get ksvc "$K_SERVICE" -n "$OCP_NAMESPACE" -o custom-columns=NAME:.metadata.name,URL:.status.url,LATEST:.status.latestReadyRevisionName --no-headers
  only:
    - main
