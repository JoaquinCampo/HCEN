stages:
  - build
  # - deploy  # Disabled due to network restrictions

variables:
  AWS_REGION: "us-east-1"
  ECR_REPOSITORY: "tse-lab-app"

build-image:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  variables:
    AWS_REGION: "us-east-1"
    AWS_DEFAULT_REGION: "us-east-1"
  before_script:
    - mkdir -p /kaniko/.docker
    - |
      echo "{\"credsStore\":\"ecr-login\"}" > /kaniko/.docker/config.json
  script:
    - IMAGE_URI="$CI_AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY"
    - |
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}" \
        --dockerfile "${CI_PROJECT_DIR}/Dockerfile" \
        --destination "${IMAGE_URI}:${CI_COMMIT_SHA}" \
        --destination "${IMAGE_URI}:latest" \
        --cache=true \
        --cache-repo="${IMAGE_URI}/cache" \
        --custom-platform=linux/amd64
  only:
    - main

# SonarQube analysis disabled - GitLab runner cannot reach SonarQube server from university network
# To run analysis manually: sh scripts/sonarqube-analysis.sh (requires network access to SonarQube)

sonarqube:
  image: maven:3.9-eclipse-temurin-17
  stage: build
  variables:
    SONAR_HOST_URL: "$SONAR_HOST_URL"
    SONAR_SCANNER_VERSION: "6.2.1.4610"
  before_script:
    - apt-get update && apt-get install -y wget unzip
    - wget -q "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux-x64.zip"
    - unzip -q "sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux-x64.zip"
    - export PATH="$PWD/sonar-scanner-${SONAR_SCANNER_VERSION}-linux-x64/bin:$PATH"
  script:
    - mvn clean verify -DskipTests=false
    - sonar-scanner -Dsonar.token="$SONAR_TOKEN" -Dsonar.host.url="$SONAR_HOST_URL" -Dsonar.projectKey="$SONAR_PROJECT_KEY"
  only:
    - main

# Deploy stage disabled - GitLab runner cannot reach EC2 from university network
# To deploy manually after build: ssh to EC2 and run:
#   cd /opt/practico && docker-compose pull && docker-compose up -d

# deploy:
#   stage: deploy
#   image: alpine:3.19
#   variables:
#     AWS_REGION: "us-east-1"
#     AWS_DEFAULT_REGION: "us-east-1"
#   before_script:
#     - apk add --no-cache openssh-client
#     - mkdir -p ~/.ssh
#     - echo "$EC2_SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
#     - chmod 600 ~/.ssh/id_rsa
#     - |
#       cat >> ~/.ssh/config <<EOF
#       Host *
#         StrictHostKeyChecking no
#         UserKnownHostsFile=/dev/null
#       EOF
#   script:
#     - |
#       ssh ec2-user@"$EC2_HOST" <<'EOF'
#       set -e
#       cd /opt/practico
#       aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin $CI_AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com
#       docker-compose pull
#       docker-compose up -d
#       EOF
#   needs:
#     - build-image
#   environment:
#     name: production
#   only:
#     - main
