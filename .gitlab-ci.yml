stages:
  - build
  - deploy

variables:
  AWS_REGION: "us-east-1"
  ECR_REPOSITORY: "tse-lab-app"

build-image:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  variables:
    AWS_REGION: "us-east-1"
    AWS_DEFAULT_REGION: "us-east-1"
  before_script:
    - mkdir -p /kaniko/.docker
    - |
      echo "{\"credsStore\":\"ecr-login\"}" > /kaniko/.docker/config.json
  script:
    - IMAGE_URI="$CI_AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY"
    - |
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}" \
        --dockerfile "${CI_PROJECT_DIR}/Dockerfile" \
        --destination "${IMAGE_URI}:${CI_COMMIT_SHA}" \
        --destination "${IMAGE_URI}:latest" \
        --cache=true \
        --cache-repo="${IMAGE_URI}/cache" \
        --custom-platform=linux/amd64
  only:
    - main

deploy:
  stage: deploy
  image: alpine:3.19
  variables:
    AWS_REGION: "us-east-1"
    AWS_DEFAULT_REGION: "us-east-1"
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$EC2_SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts
  script:
    - |
      ssh ec2-user@"$EC2_HOST" <<'EOF'
      set -e
      cd /opt/practico
      aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin $CI_AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com
      docker-compose pull
      docker-compose up -d
      EOF
  needs:
    - build-image
  environment:
    name: production
  only:
    - main
